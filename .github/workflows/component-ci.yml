# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages

name: CI

on:
  push:
    branches:
      # è§¦å‘ci/cdçš„ä»£ç åˆ†æ”¯
      - master

jobs:
  setup:
    # æŒ‡å®šæ“ä½œç³»ç»Ÿ
    runs-on: ubuntu-latest
    steps:
      # å°†ä»£ç æ‹‰åˆ°è™šæ‹Ÿæœº
      - name: è·å–æºç  ğŸ›ï¸
        uses: actions/checkout@v2

      # æŒ‡å®šnodeç‰ˆæœ¬
      - name: Nodeç¯å¢ƒç‰ˆæœ¬ ğŸ—œï¸
        uses: actions/setup-node@v3
        with:
          node-version: 18
          registry-url: 'https://registry.npmjs.org'

      - name: è·å–lockæ–‡ä»¶ ğŸ»
        uses: actions/cache@v2
        with:
          path: package-temp-dir
          key: lock-${{ github.sha }}

      # ä»…åœ¨ä¸ä¸‹è½½ä»»ä½•åŒ…çš„æƒ…å†µä¸‹ï¼Œæ›´æ–°package-lock.jsonæ–‡ä»¶ã€‚
      # è¿™ä¸ªå‘½ä»¤å¸¸ç”¨äºç¡®ä¿æ‰€æœ‰çš„ä¾èµ–é¡¹éƒ½æ˜¯æœ€æ–°çš„ï¼Œæˆ–è€…åœ¨ä½ ä¸ç¡®å®šæ›´æ–°äº†å“ªäº›åŒ…æ—¶åˆ·æ–°é”æ–‡ä»¶ã€‚
      - name: æ›´æ–°lockæ–‡ä»¶ ğŸ“Œ
        run: npm i --package-lock-only --force

      # ç¼“å­˜lockæ–‡ä»¶åˆ°package-temp-dirè·¯å¾„
      - name: ç¼“å­˜lockæ–‡ä»¶ ğŸ—¼
        run: |
          if [ ! -d "package-temp-dir" ]; then
            mkdir package-temp-dir
          fi
          cp package-lock.json package-temp-dir

      # ä¾èµ–ç¼“å­˜ç­–ç•¥
      - name: Npmç¼“å­˜ ğŸ“
        id: node_modules_cache_id
        uses: actions/cache@v2
        with:
          path: node_modules
          key: node_modules-${{ hashFiles('**/package-temp-dir/package-lock.json') }}

      # ä¾èµ–ä¸‹è½½
      - name: å®‰è£…ä¾èµ– ğŸ“¦
        if: steps.node_modules_cache_id.outputs.cache-hit != 'true'
        run: npm ci --force

  compile:
    runs-on: ubuntu-latest
    steps:
      # å°†ä»£ç æ‹‰åˆ°è™šæ‹Ÿæœº
      - name: è·å–æºç  ğŸ›ï¸
        uses: actions/checkout@v2

      # æŒ‡å®šnodeç‰ˆæœ¬
      - name: Nodeç¯å¢ƒç‰ˆæœ¬ ğŸ—œï¸
        uses: actions/setup-node@v3
        with:
          node-version: 18
          registry-url: 'https://registry.npmjs.org'

      # è·å–æˆ–å­˜çš„lockæ–‡ä»¶
      - name: è·å–lockæ–‡ä»¶ ğŸ»
        uses: actions/cache@v2
        with:
          path: package-temp-dir
          key: lock-${{ github.sha }}

      # ä¾èµ–ç¼“å­˜ç­–ç•¥
      - name: Npmç¼“å­˜ ğŸ“
        uses: actions/cache@v2
        with:
          path: node_modules
          key: node_modules-${{ hashFiles('**/package-temp-dir/package-lock.json') }}

      # åˆ¤æ–­æ˜¯å¦éœ€è¦å‘å¸ƒ
      - name: ä» package.json æ˜¯å¦éœ€è¦å‘å¸ƒ
        id: version
        run: echo "PUBLISHED=$(node -p 'require(`./package.json`).published')" >> $GITHUB_ENV

      # æ‰“åŒ…
      - name: æ‰“åŒ… ğŸ—ï¸
        run: |
          if [ ${{ env.PUBLISHED }} == "true" ]; then
            npm run compile
          fi

      # å‘å¸ƒ
      - name: å‘å¸ƒ ğŸš€
        run: |
          if [ ${{ env.PUBLISHED }} == "true" ]; then
            npm publish --access public
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    needs: setup

  site:
    runs-on: ubuntu-latest
    steps:
      # å°†ä»£ç æ‹‰åˆ°è™šæ‹Ÿæœº
      - name: è·å–æºç  ğŸ›ï¸
        uses: actions/checkout@v2

      # è·å–æˆ–å­˜çš„lockæ–‡ä»¶
      - name: è·å–lockæ–‡ä»¶ ğŸ»
        uses: actions/cache@v2
        with:
          path: package-temp-dir
          key: lock-${{ github.sha }}

      # ä¾èµ–ç¼“å­˜ç­–ç•¥
      - name: Npmç¼“å­˜ ğŸ“
        uses: actions/cache@v2
        with:
          path: node_modules
          key: node_modules-${{ hashFiles('**/package-temp-dir/package-lock.json') }}

      # ç”Ÿæˆæ–‡æ¡£
      - name: ç”Ÿæˆæ–‡æ¡£ ğŸš
        run: npm run site && touch ./_site/.nojekyll # run: touch ./_website/.nojekyllæ˜¯å› ä¸ºç”±äº Jekyll å¤„ç†,GitHub é»˜è®¤ä¸æä¾›_nextæ–‡ä»¶å¤¹,.nojekyllæ–‡ä»¶é˜»æ­¢äº†è¿™ç§æƒ…å†µ,

      - name: éƒ¨ç½² ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages # éƒ¨ç½²åæäº¤åˆ°é‚£ä¸ªåˆ†æ”¯
          folder: _site # è¿™é‡Œå¡«æ‰“åŒ…å¥½çš„ç›®å½•åç§°
          clean: true

    needs: compile

  tag:
    runs-on: ubuntu-latest
    steps:
      # å°†ä»£ç æ‹‰åˆ°è™šæ‹Ÿæœº
      - name: è·å–æºç  ğŸ›ï¸
        uses: actions/checkout@v2

      - name: ä» package.json ä¸­è·å¾—ç‰ˆæœ¬ â­
        id: version
        run: echo "VERSION=$(node -p 'require(`./package.json`).published')" >> $GITHUB_ENV

      # è·å¾—æœ€åçš„Tag
      - name: è·å¾—æœ€å Tag
        id: get_tag
        run: echo "::set-env name=LAST_TAG::$(git describe --tags --abbrev=0)"

      - name: æäº¤ Tag ğŸ„
        id: tag
        run: |
          if [ "${{ env.LAST_TAG }}" != "v${{ env.VERSION }}" ]; then
            git config --local user.email "${{ secrets.MY_GIT_USER_EMAIL }}"
            git config --local user.name "${{ secrets.MY_GIT_USER_NAME }}"
            git tag -a v${{ env.VERSION }} -m "create tag v${{ env.VERSION }}"
            git push origin v${{ env.VERSION }}
          fi

    needs: site
